<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>QBO Custom Fields PHP Sample</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f7f7f7;
    }
    h1, h2 {
      margin-top: 0;
    }
    section {
      background: #fff;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    button {
      padding: 0.5rem 1rem;
      margin-top: 0.5rem;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #0077c5;
      background: #0077c5;
      colour: #fff;
    }
    input, select {
      padding: 0.4rem 0.5rem;
      margin: 0.2rem 0 0.6rem 0;
      width: 100%;
      max-width: 320px;
    }
    pre {
      background: #111;
      colour: #0f0;
      padding: 0.75rem;
      font-size: 12px;
      border-radius: 4px;
      max-height: 300px;
      overflow: auto;
    }
    label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>QBO Custom Fields PHP Sample</h1>
  <p>This sample shows OAuth sign in, managing custom field definitions via GraphQL and creating an invoice with a Cost of Fuel custom field.</p>

  <section>
    <h2>1. Connect to QuickBooks</h2>
    <button id="btn-login">Sign in with QuickBooks</button>
  </section>

  <section>
    <h2>2. Custom fields (App Foundations GraphQL)</h2>
    <button id="btn-get-cf">Get custom fields</button>

    <h3>Create custom field</h3>
    <label>Label</label>
    <input id="cf-label" value="Cost of Fuel"/>

    <label>Data type</label>
    <select id="cf-data-type">
      <option value="STRING">STRING</option>
      <option value="NUMBER">NUMBER</option>
    </select>

    <button id="btn-create-cf">Create custom field</button>

    <h3>Update custom field</h3>
    <label>Field id</label>
    <input id="cf-update-id"/>

    <label>New label</label>
    <input id="cf-update-label"/>

    <button id="btn-update-cf">Update custom field</button>

    <h3>Validate custom fields</h3>
    <p>Test validation before creating entities. Paste JSON with custom fields:</p>
    <pre style="background: #f5f5f5; color: #333; font-size: 11px; max-height: 100px;">
{
  "customFields": [
    { "definitionId": "1", "value": 50.00, "type": "NUMBER" },
    { "definitionId": "2", "value": "Text", "type": "STRING" }
  ]
}</pre>

    <label>Validation JSON</label>
    <textarea id="cf-validate-json" rows="6" style="width: 100%; max-width: 600px; font-family: monospace; font-size: 12px;">
{
  "customFields": []
}</textarea>

    <button id="btn-validate-cf">Validate custom fields</button>

    <h3>Response</h3>
    <pre id="cf-output"></pre>
  </section>

  <section>
    <h2>3. Customers with custom fields</h2>
    <p>Create or update customers with custom fields. Paste JSON in the format below:</p>
    <pre style="background: #f5f5f5; color: #333; font-size: 11px; max-height: 150px;">
{
  "displayName": "John Doe",
  "customFields": [
    { "definitionId": "1", "value": "Premium", "type": "STRING" }
  ],
  "additionalData": {
    "GivenName": "John",
    "FamilyName": "Doe",
    "PrimaryEmailAddr": { "Address": "john@example.com" }
  }
}</pre>

    <label>Customer JSON (for create)</label>
    <textarea id="customer-json" rows="8" style="width: 100%; max-width: 600px; font-family: monospace; font-size: 12px;">
{
  "displayName": "",
  "customFields": [],
  "additionalData": {}
}</textarea>

    <button id="btn-create-customer">Create customer</button>

    <h3>Update customer</h3>
    <label>Customer ID</label>
    <input id="customer-update-id"/>

    <label>Update JSON</label>
    <textarea id="customer-update-json" rows="6" style="width: 100%; max-width: 600px; font-family: monospace; font-size: 12px;">
{
  "customFields": [],
  "additionalData": {}
}</textarea>

    <button id="btn-update-customer">Update customer</button>

    <h3>Response</h3>
    <pre id="customer-output"></pre>
  </section>

  <section>
    <h2>4. Items with custom fields</h2>
    <p>Create or update items (products/services) with custom fields. Paste JSON in the format below:</p>
    <pre style="background: #f5f5f5; color: #333; font-size: 11px; max-height: 150px;">
{
  "name": "Premium Service",
  "type": "Service",
  "customFields": [
    { "definitionId": "1", "value": 100, "type": "NUMBER" }
  ],
  "additionalData": {
    "IncomeAccountRef": { "value": "79" },
    "Description": "Premium service offering"
  }
}</pre>

    <label>Item JSON (for create)</label>
    <textarea id="item-json" rows="8" style="width: 100%; max-width: 600px; font-family: monospace; font-size: 12px;">
{
  "name": "",
  "type": "Service",
  "customFields": [],
  "additionalData": {}
}</textarea>

    <button id="btn-create-item">Create item</button>

    <h3>Update item</h3>
    <label>Item ID</label>
    <input id="item-update-id"/>

    <label>Update JSON</label>
    <textarea id="item-update-json" rows="6" style="width: 100%; max-width: 600px; font-family: monospace; font-size: 12px;">
{
  "customFields": [],
  "additionalData": {}
}</textarea>

    <button id="btn-update-item">Update item</button>

    <h3>Response</h3>
    <pre id="item-output"></pre>
  </section>

  <section>
    <h2>5. General invoice with custom fields</h2>
    <p>Create any invoice with multiple line items and custom fields. Paste JSON in the format below:</p>
    <pre style="background: #f5f5f5; color: #333; font-size: 11px; max-height: 200px;">
{
  "customerId": "1",
  "lineItems": [
    { "itemId": "1", "amount": 100.00, "quantity": 2, "description": "Service" }
  ],
  "customFields": [
    { "definitionId": "1", "value": 50.00, "type": "NUMBER" },
    { "definitionId": "2", "value": "Notes", "type": "STRING" }
  ],
  "additionalData": {
    "DocNumber": "INV-001",
    "TxnDate": "2026-01-07"
  }
}</pre>

    <label>Invoice JSON</label>
    <textarea id="general-invoice-json" rows="10" style="width: 100%; max-width: 600px; font-family: monospace; font-size: 12px;">
{
  "customerId": "",
  "lineItems": [
    { "itemId": "", "amount": 100.00 }
  ],
  "customFields": [],
  "additionalData": {}
}</textarea>

    <button id="btn-create-general-invoice">Create general invoice</button>

    <h3>Response</h3>
    <pre id="general-invoice-output"></pre>
  </section>

  <section>
    <h2>6. Cost of fuel invoice (specific example)</h2>
    <p>Use a DefinitionId (legacyIdV2 from the custom field definition) and existing Customer and Item ids from your sandbox.</p>

    <label>DefinitionId (legacyIdV2)</label>
    <input id="fuel-definition-id"/>

    <label>Customer id</label>
    <input id="fuel-customer-id"/>

    <label>Item id</label>
    <input id="fuel-item-id"/>

    <label>Fuel cost</label>
    <input id="fuel-cost" type="number" step="0.01" value="50.00"/>

    <label>Field type</label>
    <select id="fuel-field-type">
      <option value="NUMBER">NUMBER</option>
      <option value="STRING">STRING</option>
    </select>

    <button id="btn-create-fuel-invoice">Create invoice with Cost of Fuel</button>

    <h3>Response</h3>
    <pre id="fuel-output"></pre>
  </section>

<script>
document.getElementById('btn-login')?.addEventListener('click', () => {
  window.location.href = '/api/auth/login';
});

async function safeFetch(url, options) {
  const res = await fetch(url, options);
  const text = await res.text();
  try {
    const json = JSON.parse(text);
    return { status: res.status, json };
  } catch {
    return { status: res.status, json: text };
  }
}

document.getElementById('btn-get-cf')?.addEventListener('click', async () => {
  const out = document.getElementById('cf-output');
  out.textContent = 'Loading...';
  const result = await safeFetch('/api/quickbook/custom-fields', { method: 'GET' });
  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-create-cf')?.addEventListener('click', async () => {
  const label = document.getElementById('cf-label').value;
  const dataType = document.getElementById('cf-data-type').value;

  const payload = {
    label,
    dataType,
    active: true,
    associations: [
      {
        associatedEntity: 'Invoice',
        active: true,
        validationOptions: { required: false },
        allowedOperations: ['Create', 'Update'],
        associationCondition: null
      }
    ]
  };

  const out = document.getElementById('cf-output');
  out.textContent = 'Creating...';

  const result = await safeFetch('/api/quickbook/custom-fields', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-update-cf')?.addEventListener('click', async () => {
  const id = document.getElementById('cf-update-id').value;
  const newLabel = document.getElementById('cf-update-label').value;

  if (!id) {
    alert('Field id is required');
    return;
  }

  const payload = {};
  if (newLabel) payload.label = newLabel;

  const out = document.getElementById('cf-output');
  out.textContent = 'Updating...';

  const result = await safeFetch('/api/quickbook/custom-fields/' + encodeURIComponent(id), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-validate-cf')?.addEventListener('click', async () => {
  const jsonText = document.getElementById('cf-validate-json').value;
  
  let payload;
  try {
    payload = JSON.parse(jsonText);
  } catch (err) {
    alert('Invalid JSON: ' + err.message);
    return;
  }

  const out = document.getElementById('cf-output');
  out.textContent = 'Validating...';

  const result = await safeFetch('/api/quickbook/custom-fields/validate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-create-fuel-invoice')?.addEventListener('click', async () => {
  const definitionId = document.getElementById('fuel-definition-id').value;
  const customerId   = document.getElementById('fuel-customer-id').value;
  const itemId       = document.getElementById('fuel-item-id').value;
  const fuelCost     = parseFloat(document.getElementById('fuel-cost').value || '0');
  const fieldType    = document.getElementById('fuel-field-type').value;

  if (!definitionId || !customerId || !itemId) {
    alert('DefinitionId, customer id and item id are required');
    return;
  }

  const payload = { definitionId, customerId, itemId, fuelCost, fieldType };

  const out = document.getElementById('fuel-output');
  out.textContent = 'Creating invoice...';

  const result = await safeFetch('/api/quickbook/invoices/cost-of-fuel', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-create-customer')?.addEventListener('click', async () => {
  const jsonText = document.getElementById('customer-json').value;
  
  let payload;
  try {
    payload = JSON.parse(jsonText);
  } catch (err) {
    alert('Invalid JSON: ' + err.message);
    return;
  }

  const out = document.getElementById('customer-output');
  out.textContent = 'Creating customer...';

  const result = await safeFetch('/api/quickbook/customers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-update-customer')?.addEventListener('click', async () => {
  const customerId = document.getElementById('customer-update-id').value;
  const jsonText = document.getElementById('customer-update-json').value;
  
  if (!customerId) {
    alert('Customer ID is required');
    return;
  }

  let payload;
  try {
    payload = JSON.parse(jsonText);
  } catch (err) {
    alert('Invalid JSON: ' + err.message);
    return;
  }

  const out = document.getElementById('customer-output');
  out.textContent = 'Updating customer...';

  const result = await safeFetch('/api/quickbook/customers/' + encodeURIComponent(customerId), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-create-item')?.addEventListener('click', async () => {
  const jsonText = document.getElementById('item-json').value;
  
  let payload;
  try {
    payload = JSON.parse(jsonText);
  } catch (err) {
    alert('Invalid JSON: ' + err.message);
    return;
  }

  const out = document.getElementById('item-output');
  out.textContent = 'Creating item...';

  const result = await safeFetch('/api/quickbook/items', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-update-item')?.addEventListener('click', async () => {
  const itemId = document.getElementById('item-update-id').value;
  const jsonText = document.getElementById('item-update-json').value;
  
  if (!itemId) {
    alert('Item ID is required');
    return;
  }

  let payload;
  try {
    payload = JSON.parse(jsonText);
  } catch (err) {
    alert('Invalid JSON: ' + err.message);
    return;
  }

  const out = document.getElementById('item-output');
  out.textContent = 'Updating item...';

  const result = await safeFetch('/api/quickbook/items/' + encodeURIComponent(itemId), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});

document.getElementById('btn-create-general-invoice')?.addEventListener('click', async () => {
  const jsonText = document.getElementById('general-invoice-json').value;
  
  let payload;
  try {
    payload = JSON.parse(jsonText);
  } catch (err) {
    alert('Invalid JSON: ' + err.message);
    return;
  }

  const out = document.getElementById('general-invoice-output');
  out.textContent = 'Creating invoice...';

  const result = await safeFetch('/api/quickbook/invoices', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  out.textContent = JSON.stringify(result, null, 2);
});
</script>
</body>
</html>
